<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORPORATIVO IYOL - CÃ¡mara</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #e3e3f4; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .tab { background-color: #283593; color: white; padding: 25px; border-radius: 15px; margin-top: 50px; text-align: center; width: 85%; max-width: 400px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn-new { background-color: #ff7043; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 15px; }
        
        #view-camera { display: none; width: 100%; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; }
        .info-bar { background: white; width: 100%; max-width: 600px; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; }
        
        video { width: 100%; max-width: 600px; border-radius: 10px; background: black; transform: scaleX(1); }
        .controls { display: flex; gap: 10px; width: 100%; max-width: 600px; margin-top: 15px; }
        .btn-action { flex: 1; padding: 20px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 16px; }
        .btn-shot { background-color: #2196f3; }
        .btn-save { background-color: #4caf50; }
        
        #sync-banner { display: none; background: #ff9800; color: white; padding: 10px; width: 100%; text-align: center; font-size: 13px; position: fixed; top: 0; z-index: 100; }
    </style>
</head>
<body>

    <div id="sync-banner">ðŸ“¡ Tienes fotos pendientes por subir.</div>

    <div id="view-menu">
        <div class="tab">
            <h1>CORPORATIVO IYOL</h1>
            <p>ðŸ“¸ Sistema de Evidencia</p>
            <p id="local-count" style="font-size: 12px;"></p>
            <button class="btn-new" onclick="startSession()">ðŸ“‚ INICIAR CARPETA</button>
        </div>
    </div>

    <div id="view-camera">
        <div class="info-bar">
            <b id="lbl-job">EVIDENCIA</b> | Fotos: <span id="count" style="color:red">0</span>
        </div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="controls">
            <button class="btn-action btn-shot" onclick="takePhoto()">ðŸ“· FOTO</button>
            <button class="btn-action btn-save" onclick="finishSession()">ðŸ’¾ GUARDAR</button>
        </div>
        <p id="status" style="margin-top:10px; font-weight:bold;"></p>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylKfa7j3CCVd3b_JUzhwHfFMuyszIyO-MBdcQIiO-tCqACGfIL-d6gOkOISJOEBNedIQ/exec";
        let photoQueue = [];
        let stream = null;
        let db;
        let userFolder = "";
        let jobFolder = "";

        // Inicializar Base de Datos Local
        const dbReq = indexedDB.open("IyolData", 1);
        dbReq.onupgradeneeded = e => e.target.result.createObjectStore("pendientes", { autoIncrement: true });
        dbReq.onsuccess = e => { db = e.target.result; checkSync(); };

        async function startSession() {
            userFolder = prompt("Nombre del Usuario:");
            jobFolder = prompt("Nombre de la Evidencia:");
            if(!userFolder || !jobFolder) return;

            document.getElementById('lbl-job').innerText = jobFolder;
            document.getElementById('view-menu').style.display = 'none';
            document.getElementById('view-camera').style.display = 'flex';

            // INTENTO DE ABRIR CÃMARA REFORZADO
            try {
                const constraints = {
                    video: { facingMode: { ideal: "environment" } }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                alert("ERROR CÃMARA: " + err.message + "\n\n1. AsegÃºrate de estar en HTTPS.\n2. Da permiso de cÃ¡mara.");
            }
        }

        function takePhoto() {
            const v = document.getElementById('video');
            const c = document.getElementById('canvas');
            const ctx = c.getContext('2d');
            c.width = v.videoWidth;
            c.height = v.videoHeight;
            ctx.drawImage(v, 0, 0);

            const imgData = c.toDataURL('image/jpeg', 0.6);
            photoQueue.push({
                name: `${jobFolder}_${photoQueue.length + 1}.jpg`,
                data: imgData
            });
            document.getElementById('count').innerText = photoQueue.length;
            document.getElementById('status').innerText = "âœ… Foto capturada";
        }

        async function finishSession() {
            if(photoQueue.length === 0) return;
            const payload = { mainFolder: userFolder, subFolder: jobFolder, images: photoQueue };
            
            if(navigator.onLine) {
                document.getElementById('status').innerText = "â³ Subiendo...";
                enviar(payload);
            } else {
                guardarDB(payload);
            }
        }

        function guardarDB(p) {
            const trans = db.transaction(["pendientes"], "readwrite");
            trans.objectStore("pendientes").add(p);
            alert("ðŸ’¾ Guardado en el celular (Sin internet).");
            location.reload();
        }

        function enviar(p) {
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) })
            .then(() => { alert("âœ… Ã‰xito"); location.reload(); })
            .catch(() => guardarDB(p));
        }

        function checkSync() {
            const store = db.transaction("pendientes").objectStore("pendientes");
            store.count().onsuccess = e => {
                if(e.target.result > 0) {
                    document.getElementById('sync-banner').style.display = "block";
                    if(navigator.onLine) sincronizar();
                }
            };
        }

        function sincronizar() {
            const trans = db.transaction("pendientes", "readwrite");
            const store = trans.objectStore("pendientes");
            store.openCursor().onsuccess = e => {
                const cursor = e.target.result;
                if(cursor) {
                    const data = cursor.value;
                    const id = cursor.key;
                    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
                    .then(() => {
                        const dTrans = db.transaction("pendientes", "readwrite");
                        dTrans.objectStore("pendientes").delete(id);
                    });
                    cursor.continue();
                }
            };
        }
    </script>
</body>
</html>
