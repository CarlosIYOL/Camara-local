<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORPORATIVO IYOL - CÃ¡mara Offline</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #e3e3f4; }
        #view-menu { width: 100%; text-align: center; }
        .tab { background-color: #283593; color: white; padding: 30px 20px; border-radius: 15px; display: inline-block; box-shadow: 0 10px 20px rgba(0,0,0,0.2); width: 90%; max-width: 400px; }
        .btn-new { background-color: #ff7043; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; }
        #view-camera { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 800px; padding: 10px; }
        .info-bar { background: white; padding: 10px; border-radius: 8px; width: 100%; margin-bottom: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        video { width: 100%; border-radius: 10px; background: #000; }
        .controls { display: flex; justify-content: center; gap: 15px; margin-top: 15px; width: 100%; }
        .btn-action { border: none; padding: 15px 20px; border-radius: 8px; font-size: 16px; color: white; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-shot { background-color: #2196f3; }
        .btn-save { background-color: #4caf50; }
        #status { margin-top: 20px; font-weight: bold; color: #333; text-align: center;}
        
        /* Estilo para el contador de pendientes */
        #sync-banner {
            display: none; background: #ff9800; color: white; padding: 10px;
            width: 100%; position: fixed; top: 0; left: 0; text-align: center;
            font-size: 14px; font-weight: bold; z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="sync-banner">ðŸ“¡ Tienes sesiones pendientes por subir. ConÃ©ctate a internet para sincronizar.</div>

    <div id="view-menu">
        <div class="tab">
            <h1>CORPORATIVO IYOL</h1>
            <p>ðŸ“¸ Sistema de Evidencia</p>
            <p id="local-count" style="font-size: 0.8em; color: #ffccbc;"></p>
            <button class="btn-new" onclick="startSession()">ðŸ“‚ Iniciar Nueva Carpeta</button>
        </div>
    </div>

    <div id="view-camera">
        <div class="info-bar">
            <h3>ðŸ‘¤ <span id="lbl-user">---</span></h3>
            <p>ðŸ“‚ <span id="lbl-job">---</span></p>
            <p>Fotos tomadas: <span id="count" style="color:#e65100; font-weight:bold;">0</span></p>
        </div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="controls" id="controls-area">
            <button class="btn-action btn-shot" onclick="takePhoto()">ðŸ“· TOMAR FOTO</button>
            <button class="btn-action btn-save" onclick="finishSession()">ðŸ’¾ FINALIZAR</button>
        </div>
        <div id="status"></div>
    </div>
    
    <audio id="shutterSound" src="https://www.soundjay.com/mechanical/sounds/camera-shutter-click-08.mp3"></audio>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylKfa7j3CCVd3b_JUzhwHfFMuyszIyO-MBdcQIiO-tCqACGfIL-d6gOkOISJOEBNedIQ/exec";

        let userFolder = "";
        let jobFolder = "";
        let photoQueue = [];
        let stream = null;
        let db;

        // --- 1. BASE DE DATOS LOCAL ---
        const dbReq = indexedDB.open("IyolDB", 1);
        dbReq.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("pendientes", { autoIncrement: true });
        };
        dbReq.onsuccess = e => {
            db = e.target.result;
            checkPendingSync();
        };

        // --- 2. REGISTRO SERVICE WORKER (Para abrir sin internet) ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => console.log("SW Listo"));
        }

        // --- 3. INICIAR SESIÃ“N ---
        function startSession() {
            let u = prompt("PASO 1: Ingresa TU NOMBRE:");
            if (!u) return;
            let j = prompt("PASO 2: Nombre de la EVIDENCIA (Carpeta Hija):");
            if (!j) return;

            userFolder = u;
            jobFolder = j;
            lblUser.innerText = userFolder;
            lblJob.innerText = jobFolder;
            photoQueue = [];
            document.getElementById('count').innerText = "0";
            document.getElementById('view-menu').style.display = 'none';
            document.getElementById('view-camera').style.display = 'flex';
            initCamera();
        }

        function initCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(s => { stream = s; document.getElementById('video').srcObject = stream; })
                .catch(e => alert("Error cÃ¡mara: " + e.message));
        }

        // --- 4. TOMAR FOTOS ---
        function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            const shutterSound = document.getElementById('shutterSound');
            if(shutterSound) shutterSound.play().catch(() => {});

            const data = canvas.toDataURL('image/jpeg', 0.6); // Bajamos calidad a 0.6 para ahorrar espacio local
            
            // Nombre solicitado: CarpetaHija_Numero (Ej: 8684t_1.jpg)
            const name = `${jobFolder}_${photoQueue.length + 1}.jpg`;

            photoQueue.push({ name: name, data: data });
            document.getElementById('count').innerText = photoQueue.length;
            document.getElementById('status').innerText = `âœ… Foto #${photoQueue.length} capturada`;
        }

        // --- 5. FINALIZAR Y GUARDAR/SUBIR ---
        async function finishSession() {
            if (photoQueue.length === 0) return alert("No hay fotos.");
            
            const payload = {
                mainFolder: userFolder,
                subFolder: jobFolder,
                images: photoQueue
            };

            if (navigator.onLine) {
                document.getElementById('status').innerText = "â³ Subiendo a Drive...";
                enviarDrive(payload, true);
            } else {
                guardarLocal(payload);
            }
        }

        function guardarLocal(payload) {
            const trans = db.transaction(["pendientes"], "readwrite");
            trans.objectStore("pendientes").add(payload);
            alert("ðŸ“¡ SIN CONEXIÃ“N: Las fotos se guardaron en el celular. Se subirÃ¡n solas al recuperar internet.");
            location.reload();
        }

        function enviarDrive(payload, recargar) {
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            }).then(() => {
                if(recargar) {
                    alert("âœ… Enviado correctamente.");
                    location.reload();
                }
            }).catch(() => {
                if(recargar) guardarLocal(payload);
            });
        }

        // --- 6. SINCRONIZACIÃ“N AUTOMÃTICA ---
        function checkPendingSync() {
            const trans = db.transaction(["pendientes"], "readonly");
            const store = trans.objectStore("pendientes");
            const countReq = store.count();

            countReq.onsuccess = () => {
                const total = countReq.result;
                const banner = document.getElementById('sync-banner');
                const localMsg = document.getElementById('local-count');
                
                if (total > 0) {
                    banner.style.display = "block";
                    banner.innerText = `ðŸ“¡ Tienes ${total} sesiÃ³n(es) pendiente(s) por subir.`;
                    localMsg.innerText = `Pendientes localmente: ${total}`;
                    
                    if (navigator.onLine) {
                        sincronizarTodo();
                    }
                } else {
                    banner.style.display = "none";
                    localMsg.innerText = "";
                }
            };
        }

        function sincronizarTodo() {
            const trans = db.transaction(["pendientes"], "readwrite");
            const store = trans.objectStore("pendientes");
            store.openCursor().onsuccess = e => {
                const cursor = e.target.result;
                if (cursor) {
                    const data = cursor.value;
                    const id = cursor.key;
                    
                    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
                    .then(() => {
                        const delTrans = db.transaction(["pendientes"], "readwrite");
                        delTrans.objectStore("pendientes").delete(id);
                        console.log("Sincronizado ID:", id);
                    });
                    cursor.continue();
                }
            };
        }

        window.addEventListener('online', checkPendingSync);
    </script>
</body>
</html>
