<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IYOL CAM - Fix</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #e3e3f4; margin: 0; padding: 10px; }
        .tab { background: #283593; color: white; padding: 20px; border-radius: 15px; margin-top: 20px; }
        video { width: 100%; border-radius: 10px; background: #000; margin-top: 10px; }
        .btn { padding: 15px; width: 80%; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-new { background: #ff7043; color: white; }
        .btn-shot { background: #2196f3; color: white; width: 45%; }
        .btn-save { background: #4caf50; color: white; width: 45%; }
        #view-camera { display: none; }
    </style>
</head>
<body>

    <div id="view-menu">
        <div class="tab">
            <h1>CORPORATIVO IYOL</h1>
            <button class="btn btn-new" onclick="startSession()">ABRIR C√ÅMARA</button>
        </div>
    </div>

    <div id="view-camera">
        <h3 id="info-txt">Tomando fotos...</h3>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div style="display: flex; justify-content: space-around;">
            <button class="btn btn-shot" onclick="takePhoto()">üì∑ FOTO</button>
            <button class="btn btn-save" onclick="finishSession()">üíæ FINALIZAR</button>
        </div>
        <p id="count-txt">Fotos: 0</p>
        <p id="status-txt"></p>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylKfa7j3CCVd3b_JUzhwHfFMuyszIyO-MBdcQIiO-tCqACGfIL-d6gOkOISJOEBNedIQ/exec";
        let photoQueue = [];
        let userFolder = "";
        let jobFolder = "";

        async function startSession() {
            userFolder = prompt("Usuario:");
            jobFolder = prompt("Evidencia:");
            if(!userFolder || !jobFolder) return;

            document.getElementById('view-menu').style.display = 'none';
            document.getElementById('view-camera').style.display = 'block';

            // INTENTO SIMPLE DE C√ÅMARA
            const constraints = { video: { facingMode: "environment" } };
            
            navigator.mediaDevices.getUserMedia(constraints)
            .then(stream => {
                document.getElementById('video').srcObject = stream;
            })
            .catch(err => {
                alert("Error cr√≠tico de c√°mara: " + err.name + ". Aseg√∫rate de dar permisos en el candado üîí de la barra de direcciones.");
            });
        }

        function takePhoto() {
            const v = document.getElementById('video');
            const c = document.getElementById('canvas');
            c.width = v.videoWidth;
            c.height = v.videoHeight;
            c.getContext('2d').drawImage(v, 0, 0);

            photoQueue.push({
                name: `${jobFolder}_${photoQueue.length + 1}.jpg`,
                data: c.toDataURL('image/jpeg', 0.6)
            });
            document.getElementById('count-txt').innerText = "Fotos: " + photoQueue.length;
        }

        function finishSession() {
            if(photoQueue.length === 0) return;
            const payload = { mainFolder: userFolder, subFolder: jobFolder, images: photoQueue };
            
            document.getElementById('status-txt').innerText = "‚è≥ Procesando...";
            
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
            .then(() => {
                alert("‚úÖ √âxito");
                location.reload();
            })
            .catch(() => {
                alert("Guardado localmente por falta de red");
                location.reload();
            });
        }
    </script>
</body>
</html>
